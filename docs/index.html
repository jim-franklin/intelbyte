<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.9.15">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Franklin Aryee">

<title>Designing a Scalable Factory Equipment Health and Maintenance Platform</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-3ae5a7fe75b0d5b11c1bf337a5350341.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-d2ba968a340cd0d74878d6852ced13fb.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-3ae5a7fe75b0d5b11c1bf337a5350341.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-3ef427a99e8c2d4f440260184ea4771e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-e73c4175e226f8da51064820c97fb20a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-3ef427a99e8c2d4f440260184ea4771e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./images/intelbyte_logo.png" alt="" class="navbar-logo light-content">
    <img src="./images/intelbyte_logo.png" alt="" class="navbar-logo dark-content">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Report</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./presentation.html"> 
<span class="menu-text">Presentation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jim-franklin/intelbyte"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-right">
      <h1 class="title">Designing a Scalable Factory Equipment Health and Maintenance Platform</h1>
            <p class="subtitle lead">Architecture, Data Model, and Algorithms</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-right">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Franklin Aryee </p>
            </div>
    </div>
      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#executive-summary" id="toc-executive-summary" class="nav-link active" data-scroll-target="#executive-summary"><span class="header-section-number">1</span> Executive Summary</a></li>
  <li><a href="#problem-context-and-objectives" id="toc-problem-context-and-objectives" class="nav-link" data-scroll-target="#problem-context-and-objectives"><span class="header-section-number">2</span> Problem Context and Objectives</a></li>
  <li><a href="#requirements-analysis" id="toc-requirements-analysis" class="nav-link" data-scroll-target="#requirements-analysis"><span class="header-section-number">3</span> Requirements Analysis</a>
  <ul class="collapse">
  <li><a href="#core-functional-requirements" id="toc-core-functional-requirements" class="nav-link" data-scroll-target="#core-functional-requirements"><span class="header-section-number">3.1</span> Core Functional Requirements</a>
  <ul class="collapse">
  <li><a href="#asset-and-equipment-management" id="toc-asset-and-equipment-management" class="nav-link" data-scroll-target="#asset-and-equipment-management"><span class="header-section-number">3.1.1</span> Asset and Equipment Management</a></li>
  <li><a href="#telemetry-and-data-ingestion" id="toc-telemetry-and-data-ingestion" class="nav-link" data-scroll-target="#telemetry-and-data-ingestion"><span class="header-section-number">3.1.2</span> Telemetry and Data Ingestion</a></li>
  <li><a href="#operator-and-user-inputs" id="toc-operator-and-user-inputs" class="nav-link" data-scroll-target="#operator-and-user-inputs"><span class="header-section-number">3.1.3</span> Operator and User Inputs</a></li>
  <li><a href="#maintenance-management" id="toc-maintenance-management" class="nav-link" data-scroll-target="#maintenance-management"><span class="header-section-number">3.1.4</span> Maintenance Management</a></li>
  <li><a href="#health-and-status-monitoring" id="toc-health-and-status-monitoring" class="nav-link" data-scroll-target="#health-and-status-monitoring"><span class="header-section-number">3.1.5</span> Health and Status Monitoring</a></li>
  <li><a href="#reporting-and-dashboards" id="toc-reporting-and-dashboards" class="nav-link" data-scroll-target="#reporting-and-dashboards"><span class="header-section-number">3.1.6</span> Reporting and Dashboards</a></li>
  </ul></li>
  <li><a href="#operational-constraints-and-quality-considerations" id="toc-operational-constraints-and-quality-considerations" class="nav-link" data-scroll-target="#operational-constraints-and-quality-considerations"><span class="header-section-number">3.2</span> Operational Constraints and Quality Considerations</a></li>
  </ul></li>
  <li><a href="#system-architecture" id="toc-system-architecture" class="nav-link" data-scroll-target="#system-architecture"><span class="header-section-number">4</span> System Architecture</a>
  <ul class="collapse">
  <li><a href="#components-and-functions" id="toc-components-and-functions" class="nav-link" data-scroll-target="#components-and-functions"><span class="header-section-number">4.1</span> Components and Functions</a>
  <ul class="collapse">
  <li><a href="#frontend-operator-and-supervisor-interfaces" id="toc-frontend-operator-and-supervisor-interfaces" class="nav-link" data-scroll-target="#frontend-operator-and-supervisor-interfaces"><span class="header-section-number">4.1.1</span> Frontend (Operator and Supervisor Interfaces)</a></li>
  <li><a href="#backend-services-and-apis-application-and-processing-layer" id="toc-backend-services-and-apis-application-and-processing-layer" class="nav-link" data-scroll-target="#backend-services-and-apis-application-and-processing-layer"><span class="header-section-number">4.1.2</span> Backend Services and APIs (Application and Processing Layer)</a></li>
  <li><a href="#data-layer-data-storage-and-access" id="toc-data-layer-data-storage-and-access" class="nav-link" data-scroll-target="#data-layer-data-storage-and-access"><span class="header-section-number">4.1.3</span> Data Layer (Data Storage and Access)</a></li>
  <li><a href="#integrations-access-and-notifications" id="toc-integrations-access-and-notifications" class="nav-link" data-scroll-target="#integrations-access-and-notifications"><span class="header-section-number">4.1.4</span> Integrations (Access and Notifications)</a></li>
  </ul></li>
  <li><a href="#data-flow-and-communication" id="toc-data-flow-and-communication" class="nav-link" data-scroll-target="#data-flow-and-communication"><span class="header-section-number">4.2</span> Data Flow and Communication</a>
  <ul class="collapse">
  <li><a href="#telemetry-ingestion-flow" id="toc-telemetry-ingestion-flow" class="nav-link" data-scroll-target="#telemetry-ingestion-flow"><span class="header-section-number">4.2.1</span> Telemetry ingestion flow</a></li>
  <li><a href="#operator-input-flow" id="toc-operator-input-flow" class="nav-link" data-scroll-target="#operator-input-flow"><span class="header-section-number">4.2.2</span> Operator input flow</a></li>
  <li><a href="#operational-dashboard-flow" id="toc-operational-dashboard-flow" class="nav-link" data-scroll-target="#operational-dashboard-flow"><span class="header-section-number">4.2.3</span> Operational dashboard flow</a></li>
  </ul></li>
  <li><a href="#architecture-pattern-and-rationale" id="toc-architecture-pattern-and-rationale" class="nav-link" data-scroll-target="#architecture-pattern-and-rationale"><span class="header-section-number">4.3</span> Architecture Pattern and Rationale</a></li>
  </ul></li>
  <li><a href="#data-and-database-design" id="toc-data-and-database-design" class="nav-link" data-scroll-target="#data-and-database-design"><span class="header-section-number">5</span> Data and Database Design</a>
  <ul class="collapse">
  <li><a href="#data-model-overview" id="toc-data-model-overview" class="nav-link" data-scroll-target="#data-model-overview"><span class="header-section-number">5.1</span> Data Model Overview</a></li>
  <li><a href="#entity-relationship-diagram" id="toc-entity-relationship-diagram" class="nav-link" data-scroll-target="#entity-relationship-diagram"><span class="header-section-number">5.2</span> Entity Relationship Diagram</a></li>
  <li><a href="#entities-and-their-functions" id="toc-entities-and-their-functions" class="nav-link" data-scroll-target="#entities-and-their-functions"><span class="header-section-number">5.3</span> Entities and their Functions</a></li>
  <li><a href="#field-level-details" id="toc-field-level-details" class="nav-link" data-scroll-target="#field-level-details"><span class="header-section-number">5.4</span> Field Level Details</a></li>
  <li><a href="#telemetry-and-current-machine-state-strategy" id="toc-telemetry-and-current-machine-state-strategy" class="nav-link" data-scroll-target="#telemetry-and-current-machine-state-strategy"><span class="header-section-number">5.5</span> Telemetry and Current Machine State Strategy</a></li>
  </ul></li>
  <li><a href="#core-algorithms" id="toc-core-algorithms" class="nav-link" data-scroll-target="#core-algorithms"><span class="header-section-number">6</span> Core Algorithms</a>
  <ul class="collapse">
  <li><a href="#machine-health-scoring" id="toc-machine-health-scoring" class="nav-link" data-scroll-target="#machine-health-scoring"><span class="header-section-number">6.1</span> Machine Health Scoring</a>
  <ul class="collapse">
  <li><a href="#how-often-the-score-is-recalculated" id="toc-how-often-the-score-is-recalculated" class="nav-link" data-scroll-target="#how-often-the-score-is-recalculated"><span class="header-section-number">6.1.1</span> How Often the Score is Recalculated</a></li>
  <li><a href="#where-the-score-is-stored" id="toc-where-the-score-is-stored" class="nav-link" data-scroll-target="#where-the-score-is-stored"><span class="header-section-number">6.1.2</span> Where the Score is Stored</a></li>
  <li><a href="#scoring-logic" id="toc-scoring-logic" class="nav-link" data-scroll-target="#scoring-logic"><span class="header-section-number">6.1.3</span> Scoring Logic</a></li>
  <li><a href="#sec-health-score" id="toc-sec-health-score" class="nav-link" data-scroll-target="#sec-health-score"><span class="header-section-number">6.1.4</span> Pseudocode for Scoring</a></li>
  </ul></li>
  <li><a href="#latest-machine-status-resolution" id="toc-latest-machine-status-resolution" class="nav-link" data-scroll-target="#latest-machine-status-resolution"><span class="header-section-number">6.2</span> Latest Machine Status Resolution</a>
  <ul class="collapse">
  <li><a href="#status-precedence" id="toc-status-precedence" class="nav-link" data-scroll-target="#status-precedence"><span class="header-section-number">6.2.1</span> Status Precedence</a></li>
  <li><a href="#initialization-at-launch" id="toc-initialization-at-launch" class="nav-link" data-scroll-target="#initialization-at-launch"><span class="header-section-number">6.2.2</span> Initialization at Launch</a></li>
  <li><a href="#upserts" id="toc-upserts" class="nav-link" data-scroll-target="#upserts"><span class="header-section-number">6.2.3</span> Event Driven Updates</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#dashboards-and-user-experience" id="toc-dashboards-and-user-experience" class="nav-link" data-scroll-target="#dashboards-and-user-experience"><span class="header-section-number">7</span> Dashboards and User Experience</a>
  <ul class="collapse">
  <li><a href="#current-equipment-status-screen" id="toc-current-equipment-status-screen" class="nav-link" data-scroll-target="#current-equipment-status-screen"><span class="header-section-number">7.1</span> Current Equipment Status Screen</a></li>
  <li><a href="#operational-and-maintenance-views" id="toc-operational-and-maintenance-views" class="nav-link" data-scroll-target="#operational-and-maintenance-views"><span class="header-section-number">7.2</span> Operational and Maintenance Views</a></li>
  </ul></li>
  <li><a href="#security-and-data-protection" id="toc-security-and-data-protection" class="nav-link" data-scroll-target="#security-and-data-protection"><span class="header-section-number">8</span> Security and Data Protection</a>
  <ul class="collapse">
  <li><a href="#key-security-concerns" id="toc-key-security-concerns" class="nav-link" data-scroll-target="#key-security-concerns"><span class="header-section-number">8.1</span> Key Security Concerns</a></li>
  <li><a href="#authentication-and-authorization" id="toc-authentication-and-authorization" class="nav-link" data-scroll-target="#authentication-and-authorization"><span class="header-section-number">8.2</span> Authentication and Authorization</a></li>
  <li><a href="#data-integrity-and-auditability" id="toc-data-integrity-and-auditability" class="nav-link" data-scroll-target="#data-integrity-and-auditability"><span class="header-section-number">8.3</span> Data Integrity and Auditability</a></li>
  </ul></li>
  <li><a href="#scalability-and-reliability" id="toc-scalability-and-reliability" class="nav-link" data-scroll-target="#scalability-and-reliability"><span class="header-section-number">9</span> Scalability and Reliability</a>
  <ul class="collapse">
  <li><a href="#data-growth-and-performance" id="toc-data-growth-and-performance" class="nav-link" data-scroll-target="#data-growth-and-performance"><span class="header-section-number">9.1</span> Data Growth and Performance</a></li>
  <li><a href="#failure-scenarios-and-resilience" id="toc-failure-scenarios-and-resilience" class="nav-link" data-scroll-target="#failure-scenarios-and-resilience"><span class="header-section-number">9.2</span> Failure Scenarios and Resilience</a></li>
  </ul></li>
  <li><a href="#conclusion-and-recommendations" id="toc-conclusion-and-recommendations" class="nav-link" data-scroll-target="#conclusion-and-recommendations"><span class="header-section-number">10</span> Conclusion and Recommendations</a>
  <ul class="collapse">
  <li><a href="#future-enhancements" id="toc-future-enhancements" class="nav-link" data-scroll-target="#future-enhancements"><span class="header-section-number">10.1</span> Future Enhancements</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">11</span> References</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="report.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div><div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="report.pdf"><i class="bi bi-file-earmark-pdf"></i>PDF</a></li><li><a href="figures/dashboard-screens.png"><i class="bi bi-speedometer"></i>Dashboard</a></li><li><a href="presentation.html"><i class="bi bi-file-slides"></i>Slides</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-right" id="quarto-document-content">





<div style="page-break-after: always;"></div>
<section id="executive-summary" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Executive Summary</h1>
<p>This document presents the technical design for a Factory Equipment Health and Maintenance Platform developed for Intelbyte. The objective of the platform is to provide clear, real-time visibility into the health and operational status of equipment across multiple manufacturing plants, while preserving a complete historical record of machine telemetry, operator inputs, and maintenance activity for analysis, reporting, and audit purposes.</p>
<p>The proposed solution uses a scalable, event-driven data architecture that separates high-volume telemetry ingestion from day-to-day operational decision-making. Machine sensor readings such as temperature, vibration, throughput, and fault codes are captured as timestamped events for long-term retention, while a derived current equipment state is maintained for each machine. This enables supervisors to view a single, up-to-date record per asset without querying large historical datasets, even as data volumes grow.</p>
<p>The platform supports multiple plants, production lines, and machines, along with operator shift reports, manual inspections, and status overrides. Maintenance requests are generated automatically based on configurable thresholds, fault patterns, and operator-reported issues. A machine health scoring process combines recent telemetry signals and fault history into a single, easy-to-interpret score, while a clear precedence model resolves the current machine status across telemetry, operator inputs, and active work orders.</p>
<p>Overall, the design is practical, transparent, and scalable. It delivers immediate value for day-to-day operations and supports timely maintenance decisions, while leaving room to add features such as predictive maintenance, deeper analysis, and AI based insights as the platform grows.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="problem-context-and-objectives" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Problem Context and Objectives</h1>
<p>Manufacturing environments operate large numbers of machines across multiple plants and production lines, generating continuous streams of sensor data alongside operator reports and inspections. While this information is essential for monitoring equipment condition, its volume and fragmentation make it difficult to use effectively for day-to-day operational decisions.</p>
<p>A central challenge is maintaining a clear, up to date view of current equipment status while preserving complete historical data for analysis, reporting, and audits. Supervisors require a simple snapshot of machine health and status, whereas engineers and analysts need access to detailed historical records to identify trends, recurring issues, and long term performance patterns. Without a unified approach, teams often rely on manual processes, disconnected data sources, and reactive maintenance practices.</p>
<p>The objective of this platform is to address these challenges by providing a unified, scalable foundation for equipment health and maintenance management. At a high level, the platform is designed to:</p>
<ul>
<li>Provide a single, reliable view of the current status and health of each machine<br>
</li>
<li>Ingest and retain high volume telemetry data for long term analysis and audits<br>
</li>
<li>Capture operator reports, inspections, and status changes alongside sensor data<br>
</li>
<li>Automatically trigger maintenance requests based on thresholds, fault patterns, and reported issues<br>
</li>
<li>Support growth across plants, machines, and data volumes without major redesign</li>
</ul>
<div style="page-break-after: always;"></div>
</section>
<section id="requirements-analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Requirements Analysis</h1>
<p>The following requirements are defined based on the scenario provided, which assumes the availability of machine telemetry, operator inputs, and maintenance workflows typical of modern manufacturing environments.</p>
<section id="core-functional-requirements" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="core-functional-requirements"><span class="header-section-number">3.1</span> Core Functional Requirements</h2>
<p>These define the essential capabilities the platform provides to support equipment monitoring, maintenance, and operational decision-making. They are organized by functional area for clarity.</p>
<section id="asset-and-equipment-management" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="asset-and-equipment-management"><span class="header-section-number">3.1.1</span> Asset and Equipment Management</h3>
<ul>
<li>Support multiple plants, production lines, and machines<br>
</li>
<li>Maintain a clear hierarchical relationship between plants, lines, and machines</li>
</ul>
</section>
<section id="telemetry-and-data-ingestion" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="telemetry-and-data-ingestion"><span class="header-section-number">3.1.2</span> Telemetry and Data Ingestion</h3>
<ul>
<li>Ingest continuous machine telemetry, including temperature, vibration, throughput, and fault codes<br>
</li>
<li>Associate each telemetry record with a machine identifier and timestamp<br>
</li>
<li>Retain telemetry data as a complete historical record for analysis, reporting, and audits</li>
</ul>
</section>
<section id="operator-and-user-inputs" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="operator-and-user-inputs"><span class="header-section-number">3.1.3</span> Operator and User Inputs</h3>
<ul>
<li>Allow operators to log shift reports, inspection results, and issue descriptions<br>
</li>
<li>Record manual machine status updates with user attribution<br>
</li>
<li>Store operator comments and inspection notes alongside machine and telemetry data</li>
</ul>
</section>
<section id="maintenance-management" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="maintenance-management"><span class="header-section-number">3.1.4</span> Maintenance Management</h3>
<ul>
<li>Automatically create maintenance requests based on configurable thresholds, fault patterns, and operator reported issues<br>
</li>
<li>Track maintenance requests through their lifecycle, including status updates and resolution details<br>
</li>
<li>Link maintenance history to machines and triggering events</li>
</ul>
</section>
<section id="health-and-status-monitoring" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="health-and-status-monitoring"><span class="header-section-number">3.1.5</span> Health and Status Monitoring</h3>
<ul>
<li>Calculate a machine health score using recent telemetry signals and fault history<br>
</li>
<li>Determine the current machine status by reconciling telemetry data, operator inputs, and active maintenance work orders<br>
</li>
<li>Provide a Current Equipment Status view showing one row per machine using the most recent available data</li>
</ul>
</section>
<section id="reporting-and-dashboards" class="level3" data-number="3.1.6">
<h3 data-number="3.1.6" class="anchored" data-anchor-id="reporting-and-dashboards"><span class="header-section-number">3.1.6</span> Reporting and Dashboards</h3>
<ul>
<li>Provide dashboards for supervisors to monitor equipment health, status, and maintenance activity<br>
</li>
<li>Support filtering by plant, production line, machine, status, and health indicators</li>
</ul>
</section>
</section>
<section id="operational-constraints-and-quality-considerations" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="operational-constraints-and-quality-considerations"><span class="header-section-number">3.2</span> Operational Constraints and Quality Considerations</h2>
<p>Beyond core functionality, the platform is designed to operate reliably in a production environment where data volume and operational complexity increase over time. It is expected to scale to thousands of machines generating high-frequency telemetry without requiring major redesign or manual intervention.</p>
<p>Operational views used by supervisors and maintenance teams must remain highly available and reflect the latest known state of each machine in near real-time. To support audits, investigations, and long-term analysis, all telemetry and operational events are preserved as immutable historical records. The platform enforces role based access control to ensure users can only view or perform actions appropriate to their role, protecting sensitive operational data and workflows. System components are loosely coupled so ingestion, processing, analytics, and user facing features can be updated or extended independently, supporting continuous improvement without disrupting ongoing operations.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="system-architecture" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> System Architecture</h1>
<p>The platform follows an event-driven architecture that separates high-volume telemetry ingestion from operational workflows and user facing views. Machine telemetry is captured as append-only event data to support long-term retention, analysis, and auditability. In parallel, a derived current equipment state is maintained to enable fast operational queries that present one up-to-date record per machine.</p>
<p>At a high level, the system consists of a web application for operators and supervisors, backend services that manage operational workflows and business rules, a telemetry ingestion path optimized for scale, and a database layer that stores both historical telemetry and current machine state. Maintenance requests are generated through configurable rules and recorded as work items linked to the machines and events that triggered them.</p>
<div class="landscape">
<div class="cell" data-fig-width="7" data-fig-height="6" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-architecture" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-architecture-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-architecture">flowchart TB
  A[Machines or Plant Gateways] --&gt;|Telemetry Events| B[Telemetry Ingestion API]
  B --&gt; C[(Telemetry Store&lt;br/&gt;Append-only events)]
  B --&gt;|Event stream| D[Stream Processor]
  D --&gt; E[(Current State Store&lt;br/&gt;One row per machine)]

  F[Operator or Supervisor Web App] --&gt;|Authenticate| M[Identity Provider&lt;br/&gt;Microsoft Entra ID]
  M --&gt;|Access Token| G[Operational API]

  G --&gt; H[(Operational Store&lt;br/&gt;Assets, Logs, Work Orders, Users)]

  %% CHANGED: Operational Store now feeds Current State
  H --&gt;|Work order / override change events| E

  E --&gt; I[Current Equipment Status Screen]
  C --&gt; J[Analytics and Reporting]

  E --&gt; K[Health Scoring Service]
  C --&gt; K
  K --&gt; E

  E --&gt; L[Rule Engine]
  C --&gt; L
  L --&gt; H

  L --&gt; N[Notification Channel&lt;br/&gt;Teams or Email]
  G --&gt; N
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-architecture-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: System architecture and data flow
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<section id="components-and-functions" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="components-and-functions"><span class="header-section-number">4.1</span> Components and Functions</h2>
<section id="frontend-operator-and-supervisor-interfaces" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="frontend-operator-and-supervisor-interfaces"><span class="header-section-number">4.1.1</span> Frontend (Operator and Supervisor Interfaces)</h3>
<ul>
<li>Operator and Supervisor Web App (Power Apps, Copilot): provides a unified interface for operators, supervisors, and maintenance teams to view current equipment status, review machine details, log shift reports and inspections, submit maintenance requests, and review, prioritize, assign, and track maintenance work orders.</li>
<li>Analytics Dashboards (Power BI): visual dashboards showing equipment health, status, and maintenance activity by plant, production line, and machine</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="4">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/PowerApps_scalable.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Power Apps"><img src="assets/PowerApps_scalable.png" class="img-fluid figure-img" alt="Power Apps icon" width="90"></a></p>
<figcaption>Power Apps</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/PowerBI_scalable.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Power BI"><img src="assets/PowerBI_scalable.png" class="img-fluid figure-img" alt="Power BI icon" width="90"></a></p>
<figcaption>Power BI</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/CopilotStudio_scalable.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Copilot"><img src="assets/CopilotStudio_scalable.svg" class="img-fluid figure-img" alt="Copilot icon" width="90"></a></p>
<figcaption>Copilot</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/AIBuilder_scalable.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="AI Builder"><img src="assets/AIBuilder_scalable.png" class="img-fluid figure-img" alt="AIBuilder icon" width="90"></a></p>
<figcaption>AI Builder</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="backend-services-and-apis-application-and-processing-layer" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="backend-services-and-apis-application-and-processing-layer"><span class="header-section-number">4.1.2</span> Backend Services and APIs (Application and Processing Layer)</h3>
<ul>
<li>Operational API (Azure Functions): manages core business operations including plant and machine metadata, operator inputs, status updates, and maintenance workflows</li>
<li>Telemetry Ingestion API (Azure IoT Hub): receives sensor data from machines or plant gateways and checks that required information is present<br>
</li>
<li>Event Stream (Azure Event Hubs): temporarily buffers incoming telemetry to allow the system to scale and continue receiving data even during peak loads<br>
</li>
<li>Stream Processor (Azure Stream Analytics): continuously processes incoming telemetry, determines the current condition of each machine using predefined rules, and keeps the operational view up to date.</li>
<li>Rule Engine (Azure Functions): evaluates business rules against machine state and history to decide when maintenance actions are required, creating work orders and triggering notifications.<br>
</li>
<li>Health Scoring Service (Azure Functions): calculates a simple health score for each machine using recent telemetry and fault history</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="4">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/Azure_Functions.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Azure Functions"><img src="assets/Azure_Functions.svg" class="img-fluid figure-img" alt="Azure Functions icon" width="90"></a></p>
<figcaption>Azure Functions</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/IoT-Hub.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Azure IoT Hub"><img src="assets/IoT-Hub.svg" class="img-fluid figure-img" alt="Azure IoT Hub icon" width="90"></a></p>
<figcaption>Azure IoT Hub</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/Stream-Analytics.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Azure Stream Analytics"><img src="assets/Stream-Analytics.svg" class="img-fluid figure-img" alt="Azure Stream Analytics icon" width="90"></a></p>
<figcaption>Azure Stream Analytics</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/App-Services.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Azure App-Services"><img src="assets/App-Services.svg" class="img-fluid figure-img" alt="Azure App-Services icon" width="90"></a></p>
<figcaption>Azure App-Services</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="data-layer-data-storage-and-access" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="data-layer-data-storage-and-access"><span class="header-section-number">4.1.3</span> Data Layer (Data Storage and Access)</h3>
<ul>
<li>Operational Store (Dataverse or Azure SQL Database): stores structured business data including assets, users, operator reports, and maintenance records<br>
</li>
<li>Telemetry Store (Azure Data Explorer): stores all raw telemetry data as a long-term historical record for analysis and audits<br>
</li>
<li>Current State Store (Azure SQL Database): stores the latest status and health indicators for each machine to support fast operational views</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="4">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/Dataverse_scalable.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Dataverse"><img src="assets/Dataverse_scalable.png" class="img-fluid figure-img" alt="Dataverse icon" width="90"></a></p>
<figcaption>Dataverse</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/SQL-Database.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Azure SQL Database"><img src="assets/SQL-Database.svg" class="img-fluid figure-img" alt="Azure SQL Database icon" width="90"></a></p>
<figcaption>Azure SQL Database</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/Azure-Data-Explorer.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Azure Data Explorer"><img src="assets/Azure-Data-Explorer.svg" class="img-fluid figure-img" alt="Azure Data Explorer icon" width="90"></a></p>
<figcaption>Azure Data Explorer</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/Azure-Cosmos-DB.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Azure Cosmos DB"><img src="assets/Azure-Cosmos-DB.svg" class="img-fluid figure-img" alt="Azure Cosmos DB icon" width="90"></a></p>
<figcaption>Azure Cosmos DB</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="integrations-access-and-notifications" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="integrations-access-and-notifications"><span class="header-section-number">4.1.4</span> Integrations (Access and Notifications)</h3>
<ul>
<li>Identity Provider (Microsoft Entra ID): manages user login, roles, and access permissions<br>
</li>
<li>Notification Channel (Power Automate with Teams or Email): sends alerts when maintenance requests are created or critical issues are detected</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="4">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/Microsoft_Entra.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Microsoft Entra"><img src="assets/Microsoft_Entra.svg" class="img-fluid figure-img" alt="Microsoft Entra icon" width="90"></a></p>
<figcaption>Microsoft Entra</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/PowerAutomate_scalable.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14" title="Power Automate"><img src="assets/PowerAutomate_scalable.png" class="img-fluid figure-img" alt="Power Automate icon" width="90"></a></p>
<figcaption>Power Automate</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/microsoft-teams-icon.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-15" title="Teams"><img src="assets/microsoft-teams-icon.svg" class="img-fluid figure-img" alt="Teams icon" width="90"></a></p>
<figcaption>Teams</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="assets/microsoft-outlook-icon.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-16" title="Outlook"><img src="assets/microsoft-outlook-icon.svg" class="img-fluid figure-img" alt="Outlook icon" width="90"></a></p>
<figcaption>Outlook</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="data-flow-and-communication" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="data-flow-and-communication"><span class="header-section-number">4.2</span> Data Flow and Communication</h2>
<p>Telemetry and operator inputs follow different paths, but converge in the current equipment state used for operational dashboards.</p>
<section id="telemetry-ingestion-flow" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="telemetry-ingestion-flow"><span class="header-section-number">4.2.1</span> Telemetry ingestion flow</h3>
<ol type="1">
<li>Machines or plant gateways send telemetry events to the Telemetry Ingestion API</li>
<li>Events are validated and written to the Telemetry Store as immutable, append-only records</li>
<li>A stream processor consumes telemetry events and updates the Current State Store for the affected machine</li>
<li>The Health Scoring Service recalculates machine health scores based on new data or on a defined schedule</li>
<li>The Rule Engine evaluates thresholds and fault patterns and creates maintenance requests when conditions are met</li>
</ol>
</section>
<section id="operator-input-flow" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="operator-input-flow"><span class="header-section-number">4.2.2</span> Operator input flow</h3>
<ol type="1">
<li>Operators submit shift logs, inspections, comments, or manual status updates through the web application</li>
<li>The Operational API records these inputs in the Operational Store with user attribution</li>
<li>Inputs that affect machine status are reflected in the Current State Store</li>
<li>Operator-reported issues may directly trigger maintenance requests or contribute to rule evaluation</li>
</ol>
</section>
<section id="operational-dashboard-flow" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="operational-dashboard-flow"><span class="header-section-number">4.2.3</span> Operational dashboard flow</h3>
<ul>
<li>The Current Equipment Status screen queries the Current State Store to retrieve one row per machine for fast operational monitoring.</li>
<li>Historical analysis and audits query the Telemetry Store and join with operational data as needed for reporting and compliance.</li>
</ul>
</section>
</section>
<section id="architecture-pattern-and-rationale" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="architecture-pattern-and-rationale"><span class="header-section-number">4.3</span> Architecture Pattern and Rationale</h2>
<p>The architecture follows an event-driven pattern with a derived current-state view to handle high-frequency telemetry that grows rapidly over time. Telemetry is stored as immutable events to preserve a complete historical record for analysis and audits, while a separate current equipment state is maintained to support fast operational queries without scanning large historical datasets.</p>
<p>By decoupling telemetry ingestion from operational workflows, the system improves scalability and reliability. Telemetry capture can continue even if downstream processing is delayed, and user-facing views can rely on a lightweight current-state store for near real-time visibility. This design also supports incremental evolution, allowing more advanced analytics and predictive maintenance features to be added without restructuring the core architecture.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="data-and-database-design" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Data and Database Design</h1>
<p>This section explains how the platform stores, organizes, and serves data in a way that balances <strong>accuracy, scalability, and usability</strong>.<br>
The design supports both technical needs such as telemetry ingestion and analytics, and business needs such as fast operational views, traceability, and maintainable workflows.</p>
<p>At a high level, the solution separates <strong>historical data</strong> from <strong>operational state</strong>. Telemetry and logs are preserved in full for analysis and audits, while a lightweight current state model ensures that dashboards and user interfaces remain fast and simple.</p>
<section id="data-model-overview" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="data-model-overview"><span class="header-section-number">5.1</span> Data Model Overview</h2>
<p>The data model is built around three ideas.</p>
<p>First, the platform uses a clear <strong>asset hierarchy</strong> so machines can always be understood in context. Every machine belongs to a production line, and every production line belongs to a plant. This hierarchy enables filtering, reporting, and access control by site and line.</p>
<p>Second, <strong>telemetry and events are immutable</strong>. Sensor readings and machine signals are written once and never changed. This preserves data integrity and makes the system reliable for trend analysis, root cause investigation, and compliance.</p>
<p>Third, the system maintains a <strong>derived current state</strong> for each machine. Instead of recalculating status from millions of telemetry records, the platform keeps one up-to-date row per machine that reflects its latest condition. This is what operational screens and supervisors rely on.</p>
</section>
<section id="entity-relationship-diagram" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="entity-relationship-diagram"><span class="header-section-number">5.2</span> Entity Relationship Diagram</h2>
<p>The Entity Relationship Diagram below shows the core entities such as assets, telemetry, human inputs, and maintenance workflows are connected while keeping responsibilities clearly separated. See <a href="#tbl-field-level-details" class="quarto-xref">Table&nbsp;1</a> for field level details.</p>
<div class="landscape">
<div class="cell" data-fig-width="8" data-fig-height="6" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-ERD" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ERD-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-ERD">erDiagram
  Plant ||--o{ ProductionLine : contains
  
  ProductionLine ||--o{ Machine : contains
  MachineType ||--o{ Machine : classifies

  Machine ||--o{ TelemetryEvent : produces
  FaultCode ||--o{ TelemetryEvent : appears_in

  Machine ||--o{ OperatorReport : has
  User ||--o{ OperatorReport : submits

  Machine ||--o{ WorkOrder : has
  User ||--o{ WorkOrder : creates
  User ||--o{ WorkOrder : assigned_to

  ThresholdRule }o--o{ WorkOrder : triggers

  Machine ||--|| CurrentMachineState : has_latest
  TelemetryEvent }o--|| CurrentMachineState : last_telemetry
  OperatorReport }o--|| CurrentMachineState : last_operator_report
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ERD-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: High level ERD for assets, telemetry, operator inputs, and maintenance
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="entities-and-their-functions" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="entities-and-their-functions"><span class="header-section-number">5.3</span> Entities and their Functions</h2>
<p>The platform relies on a small but complete set of entities.</p>
<ul>
<li>Plants, production lines, machines, and machine types define the physical structure of the factory.</li>
<li>Telemetry events capture raw machine signals over time.</li>
<li>Operator reports capture human observations, inspections, and manual overrides.</li>
<li>Work orders represent maintenance actions from creation through closure.</li>
<li>Fault codes and threshold rules standardize how issues are detected and interpreted.</li>
<li>Current machine state provides a fast operational snapshot for each machine.</li>
</ul>
<p>Together, these entities allow the system to explain <strong><em>what happened</em></strong>, <strong><em>why it happened</em></strong>, and <strong><em>what action</em></strong> was taken.</p>
</section>
<section id="field-level-details" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="field-level-details"><span class="header-section-number">5.4</span> Field Level Details</h2>
<p>The table below lists the proposed tables with their primary keys, foreign keys, and essential fields required for the MVP.</p>
<div style="page-break-after: always;"></div>
<div class="landscape">
<div id="tbl-field-level-details" class="striped hover quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-field-level-details-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Field level details for the MVP schema
</figcaption>
<div aria-describedby="tbl-field-level-details-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table-striped table-hover caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Table</th>
<th style="text-align: left;">Primary Key</th>
<th style="text-align: left;">Related References</th>
<th style="text-align: left;">Key Fields</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>Plant</code></td>
<td style="text-align: left;"><code>plantId</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>plantCode</code>, <code>plantName</code>, <code>region</code>, <code>timezone</code>, <code>isActive</code>, <code>createdAt</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ProductionLine</code></td>
<td style="text-align: left;"><code>lineId</code></td>
<td style="text-align: left;"><code>plantId (Plant.plantId)</code></td>
<td style="text-align: left;"><code>lineCode</code>, <code>lineName</code>, <code>area</code>, <code>isActive</code>, <code>createdAt</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>MachineType</code></td>
<td style="text-align: left;"><code>machineTypeId</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>typeCode</code>, <code>typeName</code>, <code>manufacturer</code>, <code>model</code>, <code>createdAt</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>Machine</code></td>
<td style="text-align: left;"><code>machineId</code></td>
<td style="text-align: left;"><code>lineId (ProductionLine.lineId)</code>, <code>machineTypeId (MachineType.machineTypeId)</code></td>
<td style="text-align: left;"><code>machineCode</code>, <code>machineName</code>, <code>serialNumber</code>, <code>installDate</code>, <code>isActive</code>, <code>createdAt</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>FaultCode</code></td>
<td style="text-align: left;"><code>faultCodeId</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>faultCode</code>, <code>faultName</code>, <code>severity</code>, <code>description</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>TelemetryEvent</code></td>
<td style="text-align: left;"><code>telemetryEventId</code></td>
<td style="text-align: left;"><code>machineId (Machine.machineId)</code>, <code>faultCodeId (FaultCode.faultCodeId)</code></td>
<td style="text-align: left;"><code>eventTimestamp</code>, <code>ingestedAt</code>, <code>temperature</code>, <code>vibration</code>, <code>throughput</code>, <code>statusRaw</code>, <code>payloadJson</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>User</code></td>
<td style="text-align: left;"><code>userId</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>displayName</code>, <code>email</code>, <code>role</code>, <code>isActive</code>, <code>createdAt</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>OperatorReport</code></td>
<td style="text-align: left;"><code>operatorReportId</code></td>
<td style="text-align: left;"><code>machineId (Machine.machineId)</code>, <code>userId (User.userId)</code></td>
<td style="text-align: left;"><code>reportTimestamp</code>, <code>reportType</code>, <code>statusOverride</code>, <code>comment</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>WorkOrder</code></td>
<td style="text-align: left;"><code>workOrderId</code></td>
<td style="text-align: left;"><code>machineId (Machine.machineId)</code>, <code>createdByUserId (User.userId)</code>, <code>assignedToUserId (User.userId)</code></td>
<td style="text-align: left;"><code>workOrderNumber</code>, <code>priority</code>, <code>status</code>, <code>createdAt</code>, <code>closedAt</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ThresholdRule</code></td>
<td style="text-align: left;"><code>thresholdRuleId</code></td>
<td style="text-align: left;"><code>machineTypeId (MachineType.machineTypeId)</code></td>
<td style="text-align: left;"><code>ruleName</code>, <code>metricName</code>, <code>operator</code>, <code>thresholdValue</code>, <code>windowMinutes</code>, <code>severity</code>, <code>isActive</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>CurrentMachineState</code></td>
<td style="text-align: left;"><code>machineId</code></td>
<td style="text-align: left;"><code>machineId (Machine.machineId)</code>, <code>lastTelemetryEventId (TelemetryEvent.telemetryEventId)</code>, <code>lastOperatorReportId (OperatorReport.operatorReportId)</code></td>
<td style="text-align: left;"><code>resolvedStatus</code>, <code>healthScore</code>, <code>lastUpdateAt</code>, <code>openWorkOrderCount</code></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</section>
<section id="telemetry-and-current-machine-state-strategy" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="telemetry-and-current-machine-state-strategy"><span class="header-section-number">5.5</span> Telemetry and Current Machine State Strategy</h2>
<p>Telemetry data is modeled as an immutable event stream. Each new reading is inserted and never updated. This guarantees a complete and trustworthy history that can support audits, analytics, and future use cases without redesign.</p>
<p>Operational views do not query this history directly. Instead, the <code>CurrentMachineState</code> table is continuously updated as telemetry arrives, operator reports are submitted, and work orders change status. Each row represents the latest resolved view of a machine, including status, health score, and maintenance indicators.</p>
<p>This separation between append only history and derived operational state is the key scaling decision in the design. It keeps dashboards fast and predictable while preserving full historical detail for deeper analysis and long-term insight.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="core-algorithms" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Core Algorithms</h1>
<p>The platform maintains an operational view of each machine using near real time, event driven processing. As telemetry events arrive, the system updates the current machine state within seconds by resolving machine status and recalculating health indicators. Dashboards query this current state store and refresh on a short interval, providing timely and consistent operational visibility without scanning historical telemetry.</p>
<section id="machine-health-scoring" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="machine-health-scoring"><span class="header-section-number">6.1</span> Machine Health Scoring</h2>
<p>The Machine Health Scoring algorithm converts raw machine signals into a single, easy-to-understand indicator that reflects how healthy a machine is at any moment. The goal is not to predict failure perfectly in the MVP, but to provide a <strong>clear, consistent signal</strong> that helps supervisors and maintenance teams prioritize attention.</p>
<p>Industry platforms often normalize machine health score to a <strong>0100</strong> scale to simplify interpretation for operations and maintenance teams (<span class="citation" data-cites="infiniteUptimeHealthScore">Uptime (<a href="#ref-infiniteUptimeHealthScore" role="doc-biblioref">2022</a>)</span>). The score combines <strong>three ideas</strong> that are common in industrial monitoring systems:</p>
<ul>
<li><strong>Normal operation</strong> keeps the score high<br>
</li>
<li><strong>Abnormal sensor readings</strong> reduce the score gradually<br>
</li>
<li><strong>Faults and maintenance states</strong> reduce the score immediately and visibly</li>
</ul>
<p>This balance ensures the score is stable enough for dashboards while still reacting quickly to real issues.</p>
<section id="how-often-the-score-is-recalculated" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="how-often-the-score-is-recalculated"><span class="header-section-number">6.1.1</span> How Often the Score is Recalculated</h3>
<p>The health score is recalculated <strong>each time new telemetry is processed for a machine</strong>. We assume telemetry arrives about <strong>every 60 seconds</strong>, so a <strong>15-minute rolling window</strong> provides <strong>about 15 samples per metric</strong>. Hence, This window reduces short lived noise while still reacting to sustained changes in machine condition.</p>
<p>Rather than recomputing the score from full historical data, the system updates the score incrementally using the previously stored value. In practice, this is done using an <strong>Exponentially Weighted Moving Average (EWMA)</strong>, which balances responsiveness with noise reduction in streaming telemetry (<span class="citation" data-cites="montgomery2020introduction">Montgomery (<a href="#ref-montgomery2020introduction" role="doc-biblioref">2020</a>)</span>).</p>
<p>If telemetry is missing for too long, the previous score is no longer reliable. As a safeguard, when the time since the last telemetry event exceeds <strong>twice the rolling window</strong> (in this case, more than <strong>30 minutes</strong> for the 15-minute window), the smoothing state is reset and the score is reinitialized from the current raw telemetry based score. See <a href="#sec-health-score" class="quarto-xref">Section&nbsp;6.1.4</a> for the health scoring pseudocode.</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>The machines are assumed to publish telemetry approximately every <strong>60 seconds</strong>. A <strong>15-minute rolling window</strong> provides <strong>15 samples per metric</strong>. The health score is recalculated whenever new telemetry arrives and is typically updated once per minute.</p>
</div>
</div>
</div>
</section>
<section id="where-the-score-is-stored" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="where-the-score-is-stored"><span class="header-section-number">6.1.2</span> Where the Score is Stored</h3>
<p>Health scoring is performed by the Health Scoring Service (Azure Functions), which computes the score as telemetry arrives (approximately every minute). The score is stored in the <code>CurrentMachineState</code> table, which represents the latest operational view for each machine:</p>
<ul>
<li>Table: <code>CurrentMachineState</code><br>
</li>
<li>Primary key: <code>machineId</code><br>
</li>
<li>Related references:
<ul>
<li><code>machineId -&gt; Machine.machineId</code><br>
</li>
<li><code>lastTelemetryEventId -&gt; TelemetryEvent.telemetryEventId</code><br>
</li>
<li><code>lastOperatorReportId -&gt; OperatorReport.operatorReportId</code></li>
</ul></li>
</ul>
<p>The scoring service keeps health scoring independent from status resolution and maintenance workflows by updating only the fields it owns:</p>
<ul>
<li><code>healthScore</code><br>
</li>
<li><code>lastUpdateAt</code></li>
</ul>
</section>
<section id="scoring-logic" class="level3" data-number="6.1.3">
<h3 data-number="6.1.3" class="anchored" data-anchor-id="scoring-logic"><span class="header-section-number">6.1.3</span> Scoring Logic</h3>
<p>At each update, the score is computed using recent machine behavior, not the full telemetry history. The scoring logic combines:</p>
<ul>
<li>The latest telemetry readings, aggregated as rolling averages over a 15-minute window<br>
</li>
<li>Current machine status (<code>Running</code>, <code>Idle</code>, <code>Fault</code>, <code>UnderMaintenance</code>)<br>
</li>
<li>Any active fault codes and their severity (<code>High</code>, <code>Medium</code>)<br>
</li>
<li>Operator flags from inspections (<code>IssueObserved</code>, <code>MinorConcern</code>)</li>
</ul>
<p>The pseudocode in <a href="#sec-health-score" class="quarto-xref">Section&nbsp;6.1.4</a> shows how each signal contributes to the final score and how EWMA smoothing stabilizes the result for operational dashboards.</p>
</section>
<section id="sec-health-score" class="level3" data-number="6.1.4">
<h3 data-number="6.1.4" class="anchored" data-anchor-id="sec-health-score"><span class="header-section-number">6.1.4</span> Pseudocode for Scoring</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-1"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_health_score(previous_score, minutes_since_last_telemetry):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-1-2" class="code-annotation-target"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a>    rawScore <span class="op">=</span> <span class="dv">100</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-1-3" class="code-annotation-target"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a>    smoothing_param <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sensor penalties (computed from last 15 minutes of data)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-1-6" class="code-annotation-target"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a>    rawScore <span class="op">-=</span> temperature_penalty</span>
<span id="annotated-cell-1-7"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a>    rawScore <span class="op">-=</span> vibration_penalty</span>
<span id="annotated-cell-1-8"><a href="#annotated-cell-1-8" aria-hidden="true" tabindex="-1"></a>    rawScore <span class="op">-=</span> throughput_penalty</span>
<span id="annotated-cell-1-9"><a href="#annotated-cell-1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-10"><a href="#annotated-cell-1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fault severity penalties</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-1-11" class="code-annotation-target"><a href="#annotated-cell-1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> fault_severity <span class="op">==</span> <span class="st">"High"</span>:</span>
<span id="annotated-cell-1-12"><a href="#annotated-cell-1-12" aria-hidden="true" tabindex="-1"></a>        rawScore <span class="op">-=</span> <span class="dv">60</span></span>
<span id="annotated-cell-1-13"><a href="#annotated-cell-1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> fault_severity <span class="op">==</span> <span class="st">"Medium"</span>:</span>
<span id="annotated-cell-1-14"><a href="#annotated-cell-1-14" aria-hidden="true" tabindex="-1"></a>        rawScore <span class="op">-=</span> <span class="dv">30</span></span>
<span id="annotated-cell-1-15"><a href="#annotated-cell-1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-16"><a href="#annotated-cell-1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># apply operator input only if a report exists</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-1-17" class="code-annotation-target"><a href="#annotated-cell-1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> operator_flag <span class="op">==</span> <span class="st">"IssueObserved"</span>:</span>
<span id="annotated-cell-1-18"><a href="#annotated-cell-1-18" aria-hidden="true" tabindex="-1"></a>        rawScore <span class="op">-=</span> <span class="dv">20</span></span>
<span id="annotated-cell-1-19"><a href="#annotated-cell-1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> operator_flag <span class="op">==</span> <span class="st">"MinorConcern"</span>:</span>
<span id="annotated-cell-1-20"><a href="#annotated-cell-1-20" aria-hidden="true" tabindex="-1"></a>        rawScore <span class="op">-=</span> <span class="dv">10</span></span>
<span id="annotated-cell-1-21"><a href="#annotated-cell-1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-22"><a href="#annotated-cell-1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># maintenance state cap</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-1-23" class="code-annotation-target"><a href="#annotated-cell-1-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> status <span class="op">==</span> <span class="st">"UnderMaintenance"</span>:</span>
<span id="annotated-cell-1-24"><a href="#annotated-cell-1-24" aria-hidden="true" tabindex="-1"></a>        rawScore <span class="op">=</span> <span class="bu">min</span>(rawScore, <span class="dv">60</span>)</span>
<span id="annotated-cell-1-25"><a href="#annotated-cell-1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-26"><a href="#annotated-cell-1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initialization / reset rule (no previous score or stale telemetry)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-1-27" class="code-annotation-target"><a href="#annotated-cell-1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> previous_score <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> minutes_since_last_telemetry <span class="op">&gt;</span> <span class="dv">30</span>:</span>
<span id="annotated-cell-1-28"><a href="#annotated-cell-1-28" aria-hidden="true" tabindex="-1"></a>        healthScore <span class="op">=</span> rawScore</span>
<span id="annotated-cell-1-29"><a href="#annotated-cell-1-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="annotated-cell-1-30"><a href="#annotated-cell-1-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># smoothing (EWMA)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-1-31" class="code-annotation-target"><a href="#annotated-cell-1-31" aria-hidden="true" tabindex="-1"></a>        healthScore <span class="op">=</span> (</span>
<span id="annotated-cell-1-32"><a href="#annotated-cell-1-32" aria-hidden="true" tabindex="-1"></a>            smoothing_param <span class="op">*</span> rawScore <span class="op">+</span></span>
<span id="annotated-cell-1-33"><a href="#annotated-cell-1-33" aria-hidden="true" tabindex="-1"></a>            (<span class="dv">1</span> <span class="op">-</span> smoothing_param) <span class="op">*</span> previous_score</span>
<span id="annotated-cell-1-34"><a href="#annotated-cell-1-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-1-35"><a href="#annotated-cell-1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-36"><a href="#annotated-cell-1-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ensure the final score stays between 0 (worst) and 100 (best)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-1-37" class="code-annotation-target"><a href="#annotated-cell-1-37" aria-hidden="true" tabindex="-1"></a>    healthScore <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, <span class="bu">min</span>(<span class="dv">100</span>, healthScore))</span>
<span id="annotated-cell-1-38"><a href="#annotated-cell-1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-39"><a href="#annotated-cell-1-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> healthScore</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="2" data-code-annotation="1">Start from a baseline score and compute a fresh rawScore for this update.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="3" data-code-annotation="2">Set the EWMA weight so recent data influences the score without causing jumps.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="6,7,8" data-code-annotation="3">Apply penalties based on 15-minute rolling window sensor summaries</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="11" data-code-annotation="4">Apply a strong penalty when an active fault is detected, scaled by severity.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="17" data-code-annotation="5">Reduce the score when operators flag issues in inspections or shift reports.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="23" data-code-annotation="6">Cap the score during maintenance to reflect reduced availability.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="27" data-code-annotation="7">If there is no previous score (MVP start) or telemetry is stale (&gt;2 rolling window), reinitialize from rawScore.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="31" data-code-annotation="8">Otherwise smooth using EWMA to reduce noise while keeping responsiveness.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="37" data-code-annotation="9">Clamp the final score to stay between 0 and 100.</span>
</dd>
</dl>
</section>
</section>
<section id="latest-machine-status-resolution" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="latest-machine-status-resolution"><span class="header-section-number">6.2</span> Latest Machine Status Resolution</h2>
<p>The platform resolves <code>CurrentMachineState.resolvedStatus</code> by evaluating multiple signal sources in a fixed order of precedence. This ensures the resulting status is predictable, explainable, and aligned with real operational decision-making.</p>
<section id="status-precedence" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="status-precedence"><span class="header-section-number">6.2.1</span> Status Precedence</h3>
<p>Status precedence ensures maintenance and safety decisions take priority, while allowing the system to automatically return to telemetry driven status when conditions normalize. It is applied as follows (highest wins):</p>
<ol type="1">
<li><p><strong>UnderMaintenance</strong><br>
If one or more maintenance work orders are active for a machine, the machine is considered <code>UnderMaintenance</code> regardless of telemetry or operator inputs. This condition is represented by <code>openWorkOrderCount &gt; 0</code>, derived from <code>WorkOrder.status</code>.</p></li>
<li><p><strong>Manual operator override</strong><br>
If an operator submits a report containing <code>statusOverride</code>, the most recent override is applied while it is still valid. This allows short term safety or inspection decisions to override automated signals.</p></li>
<li><p><strong>Telemetry derived status</strong><br>
When neither maintenance nor a manual override is active, the status is derived from the latest telemetry event. If <code>faultCodeId</code> is present the status is <code>Fault</code>; otherwise the status falls back to the device reported operating state stored in <code>TelemetryEvent.statusRaw</code> (for example <code>Running</code> or <code>Idle</code>).</p></li>
</ol>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p><code>WorkOrder.status</code> drives <code>openWorkOrderCount</code>. Any non-zero count forces <code>CurrentMachineState.resolvedStatus = 'UnderMaintenance'</code> until all active work orders are closed and <code>openWorkOrderCount</code> returns to <code>0</code>.</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Operator overrides are intentionally time boxed (example: 4 hours). After the window expires, status resolution automatically falls back to telemetry without requiring manual cleanup.</p>
</div>
</div>
</div>
</section>
<section id="initialization-at-launch" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="initialization-at-launch"><span class="header-section-number">6.2.2</span> Initialization at Launch</h3>
<p>This runs once to create the <code>CurrentMachineState</code> at MVP launch. After this, the system stays current via event driven upserts. See <span class="citation" data-cites="upserts">(<a href="#ref-upserts" role="doc-biblioref"><strong>upserts?</strong></a>)</span>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Physical table (read model)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> CurrentMachineState (</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  machineId               BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  resolvedStatus          <span class="dt">VARCHAR</span>(<span class="dv">32</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  healthScore             <span class="dt">NUMERIC</span>(<span class="dv">5</span>,<span class="dv">2</span>) <span class="kw">NULL</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  openWorkOrderCount      <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  lastTelemetryEventId    BIGINT <span class="kw">NULL</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  lastOperatorReportId    BIGINT <span class="kw">NULL</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  lastUpdateAt            <span class="dt">TIMESTAMP</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="upserts" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="upserts"><span class="header-section-number">6.2.3</span> Event Driven Updates</h3>
<p>After the initialization, the platforms performs small targeted updates:</p>
<ul>
<li>When telemetry arrives for a machine, update that machines row<br>
</li>
<li>When a work order opens or closes for a machine, update that machines row<br>
</li>
<li>When an operator submits an override for a machine, update that machines row</li>
</ul>
<p>The query below shows per machine update executed when telemetry, work order or operator override is received for a specific machine.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The SQL code block is executed with parameters supplied by the <code>Stream Processor</code>. These parameters are taken directly from the incoming telemetry message from <code>Telemetry Ingestion API</code>. They include <code>:machineId</code>, <code>:telemetryEventId</code>, <code>:eventTimestamp</code>, <code>:statusRaw</code>, <code>:faultCodeId</code>.</p>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">-- Runs for ONE machine whenever ANY of these events occurs:</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">-- 1) telemetry event, 2) work order opened/closed, </span></span>
<span id="cb2-3"><a href="#cb2-3"></a>   <span class="dv">3</span>) <span class="kw">operator</span> override submitted, <span class="dv">4</span>) health score updated.</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">WITH</span> Incoming <span class="kw">AS</span> (</span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="kw">SELECT</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="ch">:machineId</span>                :: BIGINT        <span class="kw">AS</span> machineId,</span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="co">-- Telemetry event fields (present on telemetry events)</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="ch">:telemetryEventId</span>         :: BIGINT        <span class="kw">AS</span> telemetryEventId,</span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="ch">:eventTimestamp</span>           :: <span class="dt">TIMESTAMP</span>     <span class="kw">AS</span> eventTimestamp,</span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="ch">:statusRaw</span>                :: <span class="dt">VARCHAR</span>(<span class="dv">32</span>)   <span class="kw">AS</span> statusRaw,</span>
<span id="cb2-13"><a href="#cb2-13"></a>    <span class="ch">:faultCodeId</span>              :: BIGINT        <span class="kw">AS</span> faultCodeId,</span>
<span id="cb2-14"><a href="#cb2-14"></a></span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="co">-- Work order fields (emitted when a work order is created/updated/closed)</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="ch">:workOrderId</span>              :: BIGINT        <span class="kw">AS</span> workOrderId,</span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="ch">:workOrderCreatedAt</span>       :: <span class="dt">TIMESTAMP</span>     <span class="kw">AS</span> workOrderCreatedAt,</span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="ch">:workOrderClosedAt</span>        :: <span class="dt">TIMESTAMP</span>     <span class="kw">AS</span> workOrderClosedAt,</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="ch">:openWorkOrderCount</span>       :: <span class="dt">INT</span>           <span class="kw">AS</span> openWorkOrderCount,</span>
<span id="cb2-20"><a href="#cb2-20"></a>    <span class="ch">:workOrderCreatedByType</span>   :: <span class="dt">VARCHAR</span>(<span class="dv">32</span>)   </span>
<span id="cb2-21"><a href="#cb2-21"></a>          <span class="kw">AS</span> workOrderCreatedByType,</span>
<span id="cb2-22"><a href="#cb2-22"></a>    <span class="ch">:workOrderCreatedById</span>     :: BIGINT        </span>
<span id="cb2-23"><a href="#cb2-23"></a>          <span class="kw">AS</span> workOrderCreatedById,</span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a>    <span class="co">-- Operator report fields (emitted when an operator submits a report/override)</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>    <span class="ch">:operatorReportId</span>         :: BIGINT        <span class="kw">AS</span> operatorReportId,</span>
<span id="cb2-27"><a href="#cb2-27"></a>    <span class="ch">:reportTimestamp</span>          :: <span class="dt">TIMESTAMP</span>     <span class="kw">AS</span> reportTimestamp,</span>
<span id="cb2-28"><a href="#cb2-28"></a>    <span class="ch">:statusOverride</span>           :: <span class="dt">VARCHAR</span>(<span class="dv">32</span>)   <span class="kw">AS</span> statusOverride,</span>
<span id="cb2-29"><a href="#cb2-29"></a></span>
<span id="cb2-30"><a href="#cb2-30"></a>    <span class="co">-- Health score event fields (present on scoring events)</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>    <span class="ch">:healthScore</span>              :: <span class="dt">NUMERIC</span>(<span class="dv">5</span>,<span class="dv">2</span>)  <span class="kw">AS</span> healthScore,</span>
<span id="cb2-32"><a href="#cb2-32"></a>    <span class="ch">:healthScoreAt</span>            :: <span class="dt">TIMESTAMP</span>     <span class="kw">AS</span> healthScoreAt</span>
<span id="cb2-33"><a href="#cb2-33"></a>),</span>
<span id="cb2-34"><a href="#cb2-34"></a></span>
<span id="cb2-35"><a href="#cb2-35"></a>Existing <span class="kw">AS</span> (</span>
<span id="cb2-36"><a href="#cb2-36"></a>  <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>  <span class="kw">FROM</span> CurrentMachineState</span>
<span id="cb2-38"><a href="#cb2-38"></a>  <span class="kw">WHERE</span> machineId <span class="op">=</span> (<span class="kw">SELECT</span> machineId <span class="kw">FROM</span> Incoming)</span>
<span id="cb2-39"><a href="#cb2-39"></a>),</span>
<span id="cb2-40"><a href="#cb2-40"></a></span>
<span id="cb2-41"><a href="#cb2-41"></a>Merged <span class="kw">AS</span> (</span>
<span id="cb2-42"><a href="#cb2-42"></a>  <span class="kw">SELECT</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>    i.machineId,</span>
<span id="cb2-44"><a href="#cb2-44"></a></span>
<span id="cb2-45"><a href="#cb2-45"></a>    <span class="co">-- Keep lastest telemetry</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>    <span class="fu">COALESCE</span>(i.telemetryEventId, e.lastTelemetryEventId) <span class="kw">AS</span> lastTelemetryEventId,</span>
<span id="cb2-47"><a href="#cb2-47"></a>    <span class="fu">COALESCE</span>(i.eventTimestamp,   e.lastUpdateAt)         <span class="kw">AS</span> lastTelemetryAt,</span>
<span id="cb2-48"><a href="#cb2-48"></a>    i.statusRaw                                          <span class="kw">AS</span> statusRaw,</span>
<span id="cb2-49"><a href="#cb2-49"></a>    i.faultCodeId                                        <span class="kw">AS</span> faultCodeId,</span>
<span id="cb2-50"><a href="#cb2-50"></a></span>
<span id="cb2-51"><a href="#cb2-51"></a>    <span class="co">-- Keep latest work order signals</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>    <span class="fu">COALESCE</span>(i.openWorkOrderCount, e.openWorkOrderCount, <span class="dv">0</span>) <span class="kw">AS</span> openWorkOrderCount,</span>
<span id="cb2-53"><a href="#cb2-53"></a>    <span class="fu">COALESCE</span>(i.workOrderId, e.lastWorkOrderId) <span class="kw">AS</span> lastWorkOrderId,</span>
<span id="cb2-54"><a href="#cb2-54"></a>    <span class="fu">COALESCE</span>(i.workOrderCreatedByType, e.lastWorkOrderCreatedByType) <span class="kw">AS</span> lastWorkOrderCreatedByType,</span>
<span id="cb2-55"><a href="#cb2-55"></a>    <span class="fu">COALESCE</span>(i.workOrderCreatedById,   e.lastWorkOrderCreatedById)   <span class="kw">AS</span> lastWorkOrderCreatedById,</span>
<span id="cb2-56"><a href="#cb2-56"></a></span>
<span id="cb2-57"><a href="#cb2-57"></a>    <span class="co">-- Use createdAt/closedAt from the incoming work order event to bump freshness.</span></span>
<span id="cb2-58"><a href="#cb2-58"></a>    <span class="fu">GREATEST</span>(</span>
<span id="cb2-59"><a href="#cb2-59"></a>      <span class="fu">COALESCE</span>(i.workOrderCreatedAt, <span class="dt">TIMESTAMP</span> <span class="st">'1970-01-01'</span>),</span>
<span id="cb2-60"><a href="#cb2-60"></a>      <span class="fu">COALESCE</span>(i.workOrderClosedAt,  <span class="dt">TIMESTAMP</span> <span class="st">'1970-01-01'</span>),</span>
<span id="cb2-61"><a href="#cb2-61"></a>      <span class="fu">COALESCE</span>(e.lastUpdateAt,       <span class="dt">TIMESTAMP</span> <span class="st">'1970-01-01'</span>)</span>
<span id="cb2-62"><a href="#cb2-62"></a>    ) <span class="kw">AS</span> lastWorkOrderChangeAt,</span>
<span id="cb2-63"><a href="#cb2-63"></a></span>
<span id="cb2-64"><a href="#cb2-64"></a>    <span class="co">-- Keep latest operator override pointer</span></span>
<span id="cb2-65"><a href="#cb2-65"></a>    <span class="fu">COALESCE</span>(i.operatorReportId, e.lastOperatorReportId) <span class="kw">AS</span> lastOperatorReportId,</span>
<span id="cb2-66"><a href="#cb2-66"></a>    <span class="fu">COALESCE</span>(i.reportTimestamp,  e.lastUpdateAt)         <span class="kw">AS</span> lastOverrideAt,</span>
<span id="cb2-67"><a href="#cb2-67"></a>    i.statusOverride                                     <span class="kw">AS</span> statusOverride,</span>
<span id="cb2-68"><a href="#cb2-68"></a></span>
<span id="cb2-69"><a href="#cb2-69"></a>    <span class="co">-- Keep latest health score</span></span>
<span id="cb2-70"><a href="#cb2-70"></a>    <span class="fu">COALESCE</span>(i.healthScore,   e.healthScore)             <span class="kw">AS</span> healthScore,</span>
<span id="cb2-71"><a href="#cb2-71"></a>    <span class="fu">COALESCE</span>(i.healthScoreAt, e.lastUpdateAt)            <span class="kw">AS</span> healthScoreAt</span>
<span id="cb2-72"><a href="#cb2-72"></a>  <span class="kw">FROM</span> Incoming i</span>
<span id="cb2-73"><a href="#cb2-73"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> Existing e <span class="kw">ON</span> <span class="kw">TRUE</span></span>
<span id="cb2-74"><a href="#cb2-74"></a>)</span>
<span id="cb2-75"><a href="#cb2-75"></a></span>
<span id="cb2-76"><a href="#cb2-76"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> CurrentMachineState (</span>
<span id="cb2-77"><a href="#cb2-77"></a>  machineId,</span>
<span id="cb2-78"><a href="#cb2-78"></a>  resolvedStatus,</span>
<span id="cb2-79"><a href="#cb2-79"></a>  healthScore,</span>
<span id="cb2-80"><a href="#cb2-80"></a>  openWorkOrderCount,</span>
<span id="cb2-81"><a href="#cb2-81"></a>  lastTelemetryEventId,</span>
<span id="cb2-82"><a href="#cb2-82"></a>  lastOperatorReportId,</span>
<span id="cb2-83"><a href="#cb2-83"></a>  lastWorkOrderId,</span>
<span id="cb2-84"><a href="#cb2-84"></a>  lastWorkOrderCreatedByType,</span>
<span id="cb2-85"><a href="#cb2-85"></a>  lastWorkOrderCreatedById,</span>
<span id="cb2-86"><a href="#cb2-86"></a>  lastUpdateAt</span>
<span id="cb2-87"><a href="#cb2-87"></a>)</span>
<span id="cb2-88"><a href="#cb2-88"></a><span class="kw">SELECT</span></span>
<span id="cb2-89"><a href="#cb2-89"></a>  m.machineId,</span>
<span id="cb2-90"><a href="#cb2-90"></a></span>
<span id="cb2-91"><a href="#cb2-91"></a>  <span class="cf">CASE</span></span>
<span id="cb2-92"><a href="#cb2-92"></a>    <span class="cf">WHEN</span> m.openWorkOrderCount <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="st">'UnderMaintenance'</span></span>
<span id="cb2-93"><a href="#cb2-93"></a></span>
<span id="cb2-94"><a href="#cb2-94"></a>    <span class="cf">WHEN</span> m.statusOverride <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb2-95"><a href="#cb2-95"></a>      <span class="kw">AND</span> m.lastOverrideAt <span class="op">&gt;=</span> <span class="fu">CURRENT_TIMESTAMP</span> <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">'4 hours'</span></span>
<span id="cb2-96"><a href="#cb2-96"></a>      <span class="cf">THEN</span> m.statusOverride</span>
<span id="cb2-97"><a href="#cb2-97"></a></span>
<span id="cb2-98"><a href="#cb2-98"></a>    <span class="cf">WHEN</span> m.faultCodeId <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span> <span class="st">'Fault'</span></span>
<span id="cb2-99"><a href="#cb2-99"></a>    <span class="cf">ELSE</span> <span class="fu">COALESCE</span>(m.statusRaw, <span class="st">'Idle'</span>)</span>
<span id="cb2-100"><a href="#cb2-100"></a>  <span class="cf">END</span> <span class="kw">AS</span> resolvedStatus,</span>
<span id="cb2-101"><a href="#cb2-101"></a></span>
<span id="cb2-102"><a href="#cb2-102"></a>  m.healthScore,</span>
<span id="cb2-103"><a href="#cb2-103"></a>  m.openWorkOrderCount,</span>
<span id="cb2-104"><a href="#cb2-104"></a>  m.lastTelemetryEventId,</span>
<span id="cb2-105"><a href="#cb2-105"></a>  m.lastOperatorReportId,</span>
<span id="cb2-106"><a href="#cb2-106"></a>  m.lastWorkOrderId,</span>
<span id="cb2-107"><a href="#cb2-107"></a>  m.lastWorkOrderCreatedByType,</span>
<span id="cb2-108"><a href="#cb2-108"></a>  m.lastWorkOrderCreatedById,</span>
<span id="cb2-109"><a href="#cb2-109"></a></span>
<span id="cb2-110"><a href="#cb2-110"></a>  <span class="fu">GREATEST</span>(</span>
<span id="cb2-111"><a href="#cb2-111"></a>    <span class="fu">COALESCE</span>(m.lastTelemetryAt,         <span class="dt">TIMESTAMP</span> <span class="st">'1970-01-01'</span>),</span>
<span id="cb2-112"><a href="#cb2-112"></a>    <span class="fu">COALESCE</span>(m.lastWorkOrderChangeAt,   <span class="dt">TIMESTAMP</span> <span class="st">'1970-01-01'</span>),</span>
<span id="cb2-113"><a href="#cb2-113"></a>    <span class="fu">COALESCE</span>(m.lastOverrideAt,          <span class="dt">TIMESTAMP</span> <span class="st">'1970-01-01'</span>),</span>
<span id="cb2-114"><a href="#cb2-114"></a>    <span class="fu">COALESCE</span>(m.healthScoreAt,           <span class="dt">TIMESTAMP</span> <span class="st">'1970-01-01'</span>)</span>
<span id="cb2-115"><a href="#cb2-115"></a>  ) <span class="kw">AS</span> lastUpdateAt</span>
<span id="cb2-116"><a href="#cb2-116"></a><span class="kw">FROM</span> Merged m</span>
<span id="cb2-117"><a href="#cb2-117"></a></span>
<span id="cb2-118"><a href="#cb2-118"></a><span class="kw">ON</span> CONFLICT (machineId) DO <span class="kw">UPDATE</span></span>
<span id="cb2-119"><a href="#cb2-119"></a><span class="kw">SET</span></span>
<span id="cb2-120"><a href="#cb2-120"></a>  resolvedStatus              <span class="op">=</span> EXCLUDED.resolvedStatus,</span>
<span id="cb2-121"><a href="#cb2-121"></a>  healthScore                 <span class="op">=</span> EXCLUDED.healthScore,</span>
<span id="cb2-122"><a href="#cb2-122"></a>  openWorkOrderCount          <span class="op">=</span> EXCLUDED.openWorkOrderCount,</span>
<span id="cb2-123"><a href="#cb2-123"></a>  lastTelemetryEventId        <span class="op">=</span> EXCLUDED.lastTelemetryEventId,</span>
<span id="cb2-124"><a href="#cb2-124"></a>  lastOperatorReportId        <span class="op">=</span> EXCLUDED.lastOperatorReportId,</span>
<span id="cb2-125"><a href="#cb2-125"></a>  lastWorkOrderId             <span class="op">=</span> EXCLUDED.lastWorkOrderId,</span>
<span id="cb2-126"><a href="#cb2-126"></a>  lastWorkOrderCreatedByType  <span class="op">=</span> EXCLUDED.lastWorkOrderCreatedByType,</span>
<span id="cb2-127"><a href="#cb2-127"></a>  lastWorkOrderCreatedById    <span class="op">=</span> EXCLUDED.lastWorkOrderCreatedById,</span>
<span id="cb2-128"><a href="#cb2-128"></a>  lastUpdateAt                <span class="op">=</span> EXCLUDED.lastUpdateAt;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p><code>CurrentMachineState.lastUpdateAt</code> represents the most recent time <strong>any part of the machines current state changed</strong>. This includes:</p>
<ul>
<li>a status change driven by telemetry, work orders, or operator overrides</li>
<li>an update to <code>openWorkOrderCount</code></li>
<li>a new <code>healthScore</code> written by the Health Scoring Service</li>
</ul>
<p>Because both status resolution and health scoring update the same read model, <code>lastUpdateAt</code> reflects overall <strong>state freshness</strong>, not just telemetry arrival time.</p>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
</section>
</section>
<section id="dashboards-and-user-experience" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Dashboards and User Experience</h1>
<p>The dashboards provide a near-real time operational view of machine health, status, and maintenance activity across the fleet. Updates to the underlying data model are event driven rather than tied to a fixed polling schedule.</p>
<p>Telemetry is assumed to arrive approximately every 60 seconds per machine. Each telemetry event is processed as it arrives and immediately triggers an update to the affected machines current status and health score. Operational events, such as work order creation or closure and operator status overrides, may occur at any time and similarly trigger immediate updates to the corresponding machines current state.</p>
<p>All event driven updates are written directly to the <code>CurrentMachineState</code> table, which serves as the single read model for dashboard views. Dashboards poll this table on a short, configurable interval, typically between 30 seconds and one minute. This polling interval is chosen to balance responsiveness with visual stability for human operators, while ensuring that operational changes are reflected shortly after they occur.</p>
<p>The <code>lastUpdateAt</code> field records the most recent time any current state attribute changed, including telemetry driven status resolution, health score updates, work order activity, or operator overrides. This allows users to assess data freshness, distinguish active machines from stale ones, and detect potential reporting or connectivity issues.</p>
<div style="page-break-after: always;"></div>
<div class="landscape">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="figures/dashboard-screens.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17" title="Dashboard showing fleet wide equipment status, health scores, work orders, and maintenance actions"><img src="figures/dashboard-screens.png" class="img-fluid figure-img" style="width:100.0%" alt="Dashboard showing fleet wide equipment status, health scores, work orders, and maintenance actions"></a></p>
<figcaption>Dashboard showing fleet wide equipment status, health scores, work orders, and maintenance actions</figcaption>
</figure>
</div>
</div>
<section id="current-equipment-status-screen" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="current-equipment-status-screen"><span class="header-section-number">7.1</span> Current Equipment Status Screen</h2>
<p>The Current Equipment Status screen is the primary operator view. It answers one question quickly: what is happening right now across the line.</p>
<p><strong>What it shows</strong></p>
<ul>
<li>Fleet level counts by <code>resolvedStatus</code> (Running, Idle, Fault, UnderMaintenance)<br>
</li>
<li>A sortable table of machines with <code>resolvedStatus</code>, <code>healthScore</code>, <code>openWorkOrderCount</code>, and <code>lastUpdateAt</code><br>
</li>
<li>Quick filters (Plant, Production line, Machine type)</li>
</ul>
</section>
<section id="operational-and-maintenance-views" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="operational-and-maintenance-views"><span class="header-section-number">7.2</span> Operational and Maintenance Views</h2>
<p>The Operational and Maintenance views support supervisors and maintenance teams. They focus on exceptions and action queues rather than the full fleet.</p>
<p><strong>What it shows</strong></p>
<ul>
<li>Machines currently in <code>Fault</code> with the latest fault context<br>
</li>
<li>Machines currently <code>UnderMaintenance</code> with <code>openWorkOrderCount</code><br>
</li>
<li>A small Recently changed list using <code>lastUpdateAt</code><br>
</li>
<li>A drill down entry point using <code>lastTelemetryEventId</code> and <code>lastOperatorReportId</code></li>
</ul>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="security-and-data-protection" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Security and Data Protection</h1>
<p>The platform is designed to protect operational data, ensure controlled access, and maintain trust in machine status and maintenance decisions. Security is treated as a foundational requirement rather than an afterthought, especially given the safety and reliability implications of industrial systems.</p>
<section id="key-security-concerns" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="key-security-concerns"><span class="header-section-number">8.1</span> Key Security Concerns</h2>
<p>The primary security concerns addressed by the platform include:</p>
<ul>
<li>Unauthorized access to operational data, such as machine health, fault history, and maintenance records<br>
</li>
<li>Improper modification of machine state, which could lead to unsafe operational decisions<br>
</li>
<li>Loss of traceability, where it becomes unclear who changed a status or triggered maintenance<br>
</li>
<li>Exposure of sensitive telemetry or operational metadata across plants and regions</li>
</ul>
<p>The architecture mitigates these risks by separating ingestion, processing, and presentation layers, and by enforcing access controls at every boundary.</p>
</section>
<section id="authentication-and-authorization" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="authentication-and-authorization"><span class="header-section-number">8.2</span> Authentication and Authorization</h2>
<p>Authentication and authorization are handled centrally using Microsoft Entra ID, ensuring consistent identity management across all user interfaces and services. APIs validate access tokens on every request, ensuring users can only view or modify data permitted by their role.</p>
<p><strong>Authentication</strong><br>
All users access the platform through Entra ID using enterprise credentials. This supports single sign-on, multi-factor authentication, and centralized user lifecycle management.</p>
<p><strong>Authorization</strong><br>
Role-based access control (RBAC) governs what actions users can perform. Typical roles include:</p>
<ul>
<li>Operator: view machine status, submit operator reports<br>
</li>
<li>Supervisor: review machine health, approve or prioritize work orders<br>
</li>
<li>Maintenance team: manage work orders and maintenance actions<br>
</li>
<li>Administrator: manage users, roles, and system configuration</li>
</ul>
</section>
<section id="data-integrity-and-auditability" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="data-integrity-and-auditability"><span class="header-section-number">8.3</span> Data Integrity and Auditability</h2>
<p>Trust in machine condition and maintenance decisions is critical for safe and reliable operations. This design makes it easy to review incidents after they occur, meet regulatory requirements, and continuously improve how operational rules are applied.</p>
<p>The platform ensures data integrity and auditability through:</p>
<ul>
<li>Append-only telemetry storage, preserving all raw sensor data for analysis and audits</li>
<li>Explicit pointers in the current state, such as <code>lastTelemetryEventId</code> and <code>lastOperatorReportId</code>, which link the current view back to its source records</li>
<li>Clear separation of concerns, where:
<ul>
<li>Status resolution is handled by event processing and workflows</li>
<li>Health scoring is computed independently by a scoring service</li>
</ul></li>
<li>Timestamps on all updates, allowing operators and auditors to understand when and why a state changed</li>
</ul>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="scalability-and-reliability" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Scalability and Reliability</h1>
<p>The platform is built to scale from a small MVP deployment to a large, multi-plant industrial environment without any major redesign.</p>
<section id="data-growth-and-performance" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="data-growth-and-performance"><span class="header-section-number">9.1</span> Data Growth and Performance</h2>
<p>Telemetry data grows rapidly as machines publish frequent updates. The platform approach ensures predictable performance as the number of machines, plants, and telemetry volume increases.The architecture addresses this by:</p>
<ul>
<li>Separating historical and operational data
<ul>
<li>Raw telemetry is stored in a scalable analytics store optimized for high write volumes</li>
<li>The <code>CurrentMachineState</code> table stores only one row per machine for fast reads</li>
</ul></li>
<li>Event-driven processing</li>
</ul>
<p>Telemetry events update only the affected machines current state, avoiding periodic full-table scans or fleet-wide recomputation</p>
<ul>
<li>Read-optimized dashboards</li>
</ul>
<p>Dashboards query the <code>CurrentMachineState</code> table directly, enabling fast refreshes even as historical data grows into millions or billions of records.</p>
</section>
<section id="failure-scenarios-and-resilience" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="failure-scenarios-and-resilience"><span class="header-section-number">9.2</span> Failure Scenarios and Resilience</h2>
<p>The system is designed to remain operational under common failure scenarios:</p>
<ul>
<li>Telemetry spikes or bursts: Event buffering absorbs temporary surges without dropping data.<br>
</li>
<li>Temporary processing delays: If downstream services slow down, telemetry ingestion continues and processing resumes when capacity is available.<br>
</li>
<li>Service restarts or redeployments: Stateless processing components can restart safely, using stored state and telemetry history to resume operation.<br>
</li>
<li>Partial data loss or gaps: Rolling windows and incremental scoring ensure that short interruptions do not permanently distort machine health indicators.</li>
</ul>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="conclusion-and-recommendations" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Conclusion and Recommendations</h1>
<p>This report presents a scalable and practical approach to building a Factory Equipment Health and Maintenance Platform MVP. By separating telemetry ingestion, state resolution, health scoring, and visualization, the platform achieves clarity, performance, and operational reliability.</p>
<p>Key strengths of the proposed solution include:</p>
<ul>
<li>A clear and explainable machine status model with explicit precedence rules<br>
</li>
<li>Near real-time operational visibility without querying historical telemetry<br>
</li>
<li>Independent and incremental health scoring suitable for streaming data<br>
</li>
<li>Strong foundations for security, auditability, and role-based access</li>
</ul>
<section id="future-enhancements" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="future-enhancements"><span class="header-section-number">10.1</span> Future Enhancements</h2>
<p>As the platform evolves beyond the MVP, the following enhancements can be considered:</p>
<ul>
<li>Introduce predictive maintenance models using historical telemetry and work order outcomes<br>
</li>
<li>Refine health scoring using machine-type-specific models and adaptive thresholds<br>
</li>
<li>Add automated anomaly detection to complement rule-based logic<br>
</li>
<li>Enhance dashboards with trend views and cross-plant comparisons</li>
</ul>
<p>Overall, the architecture provides a solid foundation that balances simplicity for the MVP with a clear path toward more advanced industrial analytics and automation.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="references" class="level1" data-number="11">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">11 References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-montgomery2020introduction" class="csl-entry" role="listitem">
Montgomery, D. C. 2020. <em>Introduction to Statistical Quality Control</em>. John Wiley &amp; Sons, Incorporated. <a href="https://books.google.ca/books?id=X6JFxAEACAAJ">https://books.google.ca/books?id=X6JFxAEACAAJ</a>.
</div>
<div id="ref-infiniteUptimeHealthScore" class="csl-entry" role="listitem">
Uptime, Infinite. 2022. <span>Understanding Machine Health Score and Its Importance in Asset Reliability.</span> 2022. <a href="https://medium.com/@infiniteuptime/understanding-machine-health-score-and-its-importance-in-asset-reliability-4912218ea2f7">https://medium.com/@infiniteuptime/understanding-machine-health-score-and-its-importance-in-asset-reliability-4912218ea2f7</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>